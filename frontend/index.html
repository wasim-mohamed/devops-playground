<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>DevOps Playground — Debug UI</title>
  <!-- Socket.IO client from CDN (v4) -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 18px; }
    button { padding: 8px 12px; margin: 8px 0; }
    #logs { border:1px solid #ccc; padding:10px; height:320px; overflow:auto; white-space:pre-wrap; background:#f9f9f9;}
    #meta { margin-bottom: 8px; }
  </style>
</head>
<body>
  <h1>DevOps Playground — Debug UI</h1>
  <div id="meta">
    <strong>Socket status:</strong> <span id="status">—</span><br/>
    <strong>Socket id:</strong> <span id="sid">—</span>
  </div>

  <button id="run">Run Pipeline</button>
  <button id="emit">Manual Emit (test)</button>

  <h3>Logs</h3>
  <div id="logs">— waiting for logs —</div>

  <h3>Last POST Response</h3>
  <pre id="lastpost">—</pre>

<script>
  // connect to your backend Socket.IO server
  // transports: prefer websocket, fallback to polling
  const socket = io("http://localhost:5000", { transports: ['websocket','polling'], timeout: 20000 });

  const statusEl = document.getElementById('status');
  const sidEl = document.getElementById('sid');
  const logsEl = document.getElementById('logs');
  const lastpostEl = document.getElementById('lastpost');

  // display messages on the page and console
  function append(msg){
    const t = new Date().toISOString() + ' ' + msg;
    if(logsEl.textContent.trim() === '— waiting for logs —') logsEl.textContent = '';
    logsEl.textContent += t + '\n';
    logsEl.scrollTop = logsEl.scrollHeight;
    console.log(t);
  }

  // Socket event handlers
  socket.on('connect', () => {
    statusEl.textContent = 'connected';
    sidEl.textContent = socket.id;
    append('Socket connected (id=' + socket.id + ')');
  });

  socket.on('connect_error', (err) => {
    statusEl.textContent = 'connect_error';
    append('Socket connect_error: ' + (err && err.message ? err.message : JSON.stringify(err)));
    console.error('connect_error', err);
  });

  socket.on('disconnect', (reason) => {
    statusEl.textContent = 'disconnected';
    append('Socket disconnected: ' + reason);
  });

  socket.on('log', (d) => {
    append('[LOG][' + (d.stage||'?') + '] ' + (d.msg||'') + ' (pid=' + (d.pid||'?') + ')');
  });

  socket.on('pipeline_done', (d) => {
    append('[DONE] Pipeline finished: ' + (d.pid||'?'));
  });

  // Run pipeline button -> POST /api/pipelines/run
  document.getElementById('run').onclick = async () => {
    append('[UI] Run button clicked — sending POST /api/pipelines/run');
    try {
      const res = await fetch('http://localhost:5000/api/pipelines/run', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({})
      });
      const text = await res.text();
      lastpostEl.textContent = `Status: ${res.status}\nBody: ${text}`;
      append('[UI] POST completed. Status=' + res.status);
      try { const j = JSON.parse(text); append('[UI] Parsed id=' + (j.id||'none')); } catch(e) { append('[UI] Response not JSON: ' + e.message); }
    } catch(err){
      append('[UI] POST failed: ' + err.message);
      console.error('POST error', err);
    }
  };

  // Manual Emit button for quick test via backend endpoint
  document.getElementById('emit').onclick = async () => {
    append('[UI] Manual Emit clicked — hitting /api/emit_test');
    try {
      const r = await fetch('http://localhost:5000/api/emit_test');
      const j = await r.json();
      append('[UI] emit_test response: ' + JSON.stringify(j));
    } catch(e) {
      append('[UI] emit_test failed: ' + e.message);
      console.error('emit_test error', e);
    }
  };
</script>
</body>
</html>
